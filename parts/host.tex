\chapter {Hosting Environment}

The `host'. Stuff about that.

TODO: Clear responsibility domain. Host code: Shuts down on
      signals/plugin-initiated aborts (memory errors). Instrumented plugin is
      responsible for calling abort functions prior to misbehavior. Instrumented
      code: Trusted. Uninstrumented code: Not so much.


\section {Plugin Types}

\subsection {Continuously-Running Plugins}

Plugins running on its own, doing its thing. Naturally takes a 1-to-1 mapping?

\subsection {Event-Based}

Plugins respond to events, such as audio-buffer callbacks. This can take the
form of tasks, where ยง


\section {Global Initialization}

Init shadow mem etc.


\section {Plugin Startup}

How load plugin? How load new instances. What are? dlls. etc?


\section {Plugin Switching}

Thread-pool stuff.


\section {Error Recovery}

Ideally a plugin instance should shut down gracefully when misbehaving.
Allocated resources, such as memory or file descriptors, should be deallocated
or closed. These resources need to be tracked, even for the case where a plugin
doesn't per-se misbehave. Even if a plugin exits properly, but haven't for
instance closed file descriptors or \texttt{free}'d all allocated memory, we'd
have memory leaks that can potentially be quite severe.

The requirements for properly sandboxed plugins are more strict than that
however. A malicious plugin can call any external functions with completely
arbitrary arguments. This includes double-\texttt{free}'ing previously
allocated memory, a bug which can lead to serious memory corruption for the
entire process from which it is not able to recover.

This provides a clear protection domain. Any function calls external to the
module must be individually examined, and all arguments sanity checked.
\texttt{div} for instance can't expect a non-zero divisor. It also means that
no external function call can expect a following call with certain arguments;
\texttt{malloc} can't expect a matching \texttt{free}, \texttt{fopen} can't
expect a matching \texttt{fclose}. External functions will be discussed further
in Chapter {chapref}. 

In short, there should be no state from which the host can't recover. No code
should, after modification, be able to make the host environment misbehave.

\subsection {Signal Handling}

Signals indicating errors should cause a plugin instance to shut down, and
indicate to the managing thread that this occurred. The host can then free
resources allocated to the plug-in. The host can then optionally reboot the
thread and plugin.

TODO: Describe that signal handler.
